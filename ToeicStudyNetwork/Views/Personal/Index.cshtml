@model ToeicStudyNetwork.Models.UserModel
@{
    ViewData["Title"] = "Personal Page";
}
@section customHead {
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/personal_index.css" asp-append-version="true" />
}

<!-- Header Section -->
<header class="bg-light">
    <div class="container py-5 text-center"
        style="background-image: url(https://firebasestorage.googleapis.com/v0/b/toeicstudynetwork.appspot.com/o/userBackground%2Fuser_background_6.jpg?alt=media&token=5e1ff5ee-7c91-4413-b4be-9c728f407da4); width: 100%; height: 50vh; background-repeat: no-repeat; background-size: cover;">
        <div class="d-flex justify-content-center flex-column align-items-center">
            <a id="choose-image-button" class="image-container p-2 hover-pointer">
                <img src="@Model.ImageUrl" alt="Profile Picture" class="rounded-circle"
                    style="height: 100px; width: 100px; background-color: white;">
                <div class="overlay-text">Thay đổi hình ảnh</div>
            </a>
            <div>
                <div class="d-flex flex-row justify-content-center align-items-center" id="username-wrapper">
                    <h2 class="mt-4 text-black fw-bold" id="username">@Model.Username</h2>
                    <a class="hover-pointer justify-content-between align-items-center ms-2 mt-3">
                        <i class="bi bi-pencil" id="change-name-button"></i>
                    </a>
                </div>
                <h5 class="text-black fw-bold">@Model.Email</h5>
            </div>
        </div>
    </div>
</header>

<!-- Navigation Tabs -->
<div class="container mt-4">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link" href="#">Khoá học</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Kết quả luyện thi</a>
        </li>
    </ul>
</div>

<!-- Main Content -->
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
        <h6 class="mb-0">New Economy TOEIC Test 1</h6>
        <a href="#" class="btn btn-link text-decoration-none">Tới trang thống kê kết quả luyện thi</a>
    </div>

    <!-- Table Section -->
    <div class="table-responsive mt-3">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Ngày làm</th>
                    <th>Kết quả</th>
                    <th>Thời gian làm bài</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>11/11/2024</td>
                    <td><span class="badge bg-success">Full test</span> 12/200 (Điểm: 70)</td>
                    <td>0:00:47</td>
                    <td><a href="#" class="btn btn-sm btn-primary">Xem chi tiết</a></td>
                </tr>
                <tr>
                    <td>11/11/2024</td>
                    <td>8/25</td>
                    <td>0:00:32</td>
                    <td><a href="#" class="btn btn-sm btn-primary">Xem chi tiết</a></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const usernameWrapper = document.getElementById("username-wrapper");
    const usernameElement = document.getElementById("username");
    const changeNameButton = document.getElementById("change-name-button");

    // Sự kiện khi bấm nút "Sửa tên"
    changeNameButton.addEventListener("click", () => {
        // Lấy giá trị username hiện tại
        const currentUsername = usernameElement.textContent;

        // Thay thế toàn bộ nội dung trong username-wrapper
        usernameWrapper.classList.remove("flex-row");
        usernameWrapper.classList.remove("justify-content-center");
        usernameWrapper.classList.add("flex-column");
        usernameWrapper.innerHTML = `
            <input type="text" id="username-input" class="form-control me-2" value="${currentUsername}">
            <div class="d-flex justify-content-between mt-2 w-100">
                <a class="btn btn-success btn-sm me-2" id="confirm-button">Xác nhận</a>
                <a class="btn btn-danger btn-sm" id="cancel-button">Huỷ</a>
            </div>
        `;

        // Gán sự kiện cho nút "Xác nhận"
        const confirmButton = document.getElementById("confirm-button");
        confirmButton.addEventListener("click", () => {
            const newUsername = document.getElementById("username-input").value;

            // Gọi API để cập nhật tên người dùng
            fetch('/Personal/UpdateUserInfor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: newUsername })
            })
                .then(response => {
                    if (response.ok) {
                        alert("Tên người dùng đã được cập nhật thành công!");

                        // Khôi phục nội dung username-wrapper
                        usernameWrapper.classList.add("flex-row");
                        usernameWrapper.classList.add("justify-content-center");
                        usernameWrapper.classList.remove("flex-column");

                        usernameWrapper.innerHTML = `
                        <h2 class="mt-4 text-black fw-bold" id="username">${newUsername}</h2>
                        <a class="hover-pointer justify-content-between align-items-center ms-2 mt-3">
                            <i class="bi bi-pencil" id="change-name-button"></i>
                        </a>
                    `;

                        // Gán lại sự kiện cho nút sửa tên
                        document.getElementById("change-name-button").addEventListener("click", () => {
                            changeNameButton.click();
                        });
                    } else {
                        alert("Cập nhật thất bại. Vui lòng thử lại.");
                    }
                })
                .catch(error => {
                    console.error("Lỗi:", error);
                    alert("Đã xảy ra lỗi khi cập nhật tên người dùng.");
                });
        });

        // Gán sự kiện cho nút "Huỷ"
        const cancelButton = document.getElementById("cancel-button");
        cancelButton.addEventListener("click", () => {
            // Khôi phục nội dung username-wrapper về trạng thái ban đầu
            usernameWrapper.classList.add("flex-row");
            usernameWrapper.classList.add("justify-content-center");
            usernameWrapper.classList.remove("flex-column");
            usernameWrapper.innerHTML = `
                <h2 class="mt-4 text-black fw-bold" id="username">${currentUsername}</h2>
                <a class="hover-pointer justify-content-between align-items-center ms-2 mt-3">
                    <i class="bi bi-pencil" id="change-name-button"></i>
                </a>
            `;

            // Gán lại sự kiện cho nút sửa tên
            document.getElementById("change-name-button").addEventListener("click", () => {
                changeNameButton.click();
            });
        });
    });
</script>
